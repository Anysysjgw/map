package cn.com.chinatelecom.map.handle;

import java.io.File;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.fileupload.FileItem;

import cn.com.chinatelecom.map.common.Config;
import cn.com.chinatelecom.map.entity.Grid;
import cn.com.chinatelecom.map.utils.FileUtils;
import cn.com.chinatelecom.map.utils.StringUtils;

/**
 * @author joseph
 *
 */
public class UploadHandler implements IHandler {

	/*
	 * (non-Javadoc)
	 * 
	 * @see cn.com.chinatelecom.map.handle.IHandler#handle(java.util.List)
	 */
	@Override
	public Map<String, Object> handle(List<FileItem> items) {
		Map<String, Object> result = new HashMap<String, Object>();
		if (items == null) {
			logger.warn("没有请求数据!");
			return null;
		}
		for (FileItem item : items) {
			if (item.isFormField()) {
				String fieldName = item.getFieldName();
				String string = item.getString();
				result.put(fieldName, string);
			} else {
				String filename = item.getName().trim();
				filename = StringUtils.getFileName(filename);
				if (!StringUtils.isLegal(filename, ".xls$")) {
					logger.error("文件格式有误: " + filename);
					return result;
				}
				File file = new File(Config.getInstance()
						.getValue("uploadPath") + filename);

				try {
					FileUtils.writeFile(item.getInputStream(), file);
				} catch (Exception e) {
					logger.fatal("上传文件发生致命错误: " + e.getMessage());
					return result;
				}

				String content = FileUtils.readFile(file);
				result.put("content", content);
				String[] splits = content.split("<br/>");
				Grid grid;
				for (String split : splits) {
					if (!split.trim().equals("")) {
						grid = new Grid(split);
						grid.insert();
					}
				}
				file.delete();
				logger.info("文件上传成功: " + filename);

				// --------------------Test MongoDB Start--------------------
				// 北区局
				// grid = new Grid(
				// "{'GRID_CODE':'0','GRID_NAME':'北区局','GRID_COORDINATES':[{LONGITUDE:121.40850,LATITUDE:31.34395},{LONGITUDE:121.40584,LATITUDE:31.34146},{LONGITUDE:121.41022,LATITUDE:31.32921},{LONGITUDE:121.40756,LATITUDE:31.32298},{LONGITUDE:121.40713,LATITUDE:31.31880},{LONGITUDE:121.40756,LATITUDE:31.31308},{LONGITUDE:121.40352,LATITUDE:31.30611},{LONGITUDE:121.39515,LATITUDE:31.30956},{LONGITUDE:121.38983,LATITUDE:31.30975},{LONGITUDE:121.38790,LATITUDE:31.30813},{LONGITUDE:121.38606,LATITUDE:31.30934},{LONGITUDE:121.38159,LATITUDE:31.31000},{LONGITUDE:121.37889,LATITUDE:31.30857},{LONGITUDE:121.36799,LATITUDE:31.30876},{LONGITUDE:121.36202,LATITUDE:31.30600},{LONGITUDE:121.35353,LATITUDE:31.30780},{LONGITUDE:121.35374,LATITUDE:31.30479},{LONGITUDE:121.35014,LATITUDE:31.30468},{LONGITUDE:121.34529,LATITUDE:31.29970},{LONGITUDE:121.34110,LATITUDE:31.30028},{LONGITUDE:121.34190,LATITUDE:31.29739},{LONGITUDE:121.33334,LATITUDE:31.29502},{LONGITUDE:121.34054,LATITUDE:31.28631},{LONGITUDE:121.33998,LATITUDE:31.28439},{LONGITUDE:121.33874,LATITUDE:31.28431},{LONGITUDE:121.33830,LATITUDE:31.28395},{LONGITUDE:121.34408,LATITUDE:31.28305},{LONGITUDE:121.36689,LATITUDE:31.27729},{LONGITUDE:121.36704,LATITUDE:31.27390},{LONGITUDE:121.36638,LATITUDE:31.27081},{LONGITUDE:121.38867,LATITUDE:31.26696},{LONGITUDE:121.39211,LATITUDE:31.27010},{LONGITUDE:121.39977,LATITUDE:31.27113},{LONGITUDE:121.44875,LATITUDE:31.26181},{LONGITUDE:121.47317,LATITUDE:31.25256},{LONGITUDE:121.47724,LATITUDE:31.25359},{LONGITUDE:121.47917,LATITUDE:31.24610},{LONGITUDE:121.48261,LATITUDE:31.24753},{LONGITUDE:121.48716,LATITUDE:31.24618},{LONGITUDE:121.49312,LATITUDE:31.25018},{LONGITUDE:121.50025,LATITUDE:31.24871},{LONGITUDE:121.50269,LATITUDE:31.25084},{LONGITUDE:121.49857,LATITUDE:31.25700},{LONGITUDE:121.50308,LATITUDE:31.27435},{LONGITUDE:121.50587,LATITUDE:31.27387},{LONGITUDE:121.50934,LATITUDE:31.28004},{LONGITUDE:121.50578,LATITUDE:31.28235},{LONGITUDE:121.49420,LATITUDE:31.28260},{LONGITUDE:121.49008,LATITUDE:31.28103},{LONGITUDE:121.48488,LATITUDE:31.28198},{LONGITUDE:121.47651,LATITUDE:31.28587},{LONGITUDE:121.46888,LATITUDE:31.28598},{LONGITUDE:121.46832,LATITUDE:31.28807},{LONGITUDE:121.46883,LATITUDE:31.29097},{LONGITUDE:121.46797,LATITUDE:31.29485},{LONGITUDE:121.46673,LATITUDE:31.29606},{LONGITUDE:121.46978,LATITUDE:31.30021},{LONGITUDE:121.47154,LATITUDE:31.30388},{LONGITUDE:121.47063,LATITUDE:31.31077},{LONGITUDE:121.47703,LATITUDE:31.31183},{LONGITUDE:121.48390,LATITUDE:31.31799},{LONGITUDE:121.48480,LATITUDE:31.32148},{LONGITUDE:121.48209,LATITUDE:31.32804},{LONGITUDE:121.47529,LATITUDE:31.32638},{LONGITUDE:121.47433,LATITUDE:31.33493},{LONGITUDE:121.46956,LATITUDE:31.33310},{LONGITUDE:121.46042,LATITUDE:31.33288},{LONGITUDE:121.45188,LATITUDE:31.32998},{LONGITUDE:121.44351,LATITUDE:31.34890},{LONGITUDE:121.43656,LATITUDE:31.34813},{LONGITUDE:121.43321,LATITUDE:31.34450},{LONGITUDE:121.42540,LATITUDE:31.34351},{LONGITUDE:121.41889,LATITUDE:31.34498}]}");
				// grid.insert();
				// 海川分局
				// grid = new Grid(
				// "{'GRID_CODE':'1','GRID_NAME':'海川分局','GRID_COORDINATES':[{LONGITUDE:121.48482,LATITUDE:31.28166},{LONGITUDE:121.48294,LATITUDE:31.27662},{LONGITUDE:121.47983,LATITUDE:31.27375},{LONGITUDE:121.48665,LATITUDE:31.26623},{LONGITUDE:121.48723,LATITUDE:31.26145},{LONGITUDE:121.48554,LATITUDE:31.25867},{LONGITUDE:121.47724,LATITUDE:31.25359},{LONGITUDE:121.47917,LATITUDE:31.24610},{LONGITUDE:121.48261,LATITUDE:31.24753},{LONGITUDE:121.48716,LATITUDE:31.24618},{LONGITUDE:121.49312,LATITUDE:31.25018},{LONGITUDE:121.50025,LATITUDE:31.24871},{LONGITUDE:121.50269,LATITUDE:31.25084},{LONGITUDE:121.49857,LATITUDE:31.25700},{LONGITUDE:121.50308,LATITUDE:31.27435},{LONGITUDE:121.50587,LATITUDE:31.27387},{LONGITUDE:121.50934,LATITUDE:31.28004},{LONGITUDE:121.50578,LATITUDE:31.28235},{LONGITUDE:121.49420,LATITUDE:31.28260},{LONGITUDE:121.49008,LATITUDE:31.28103}]}");
				// grid.insert();
				// 甘泉分局
				// grid = new Grid(
				// "{'GRID_CODE':'2','GRID_NAME':'甘泉分局','GRID_COORDINATES':[{LONGITUDE:121.40352,LATITUDE:31.30611},{LONGITUDE:121.39515,LATITUDE:31.30956},{LONGITUDE:121.38983,LATITUDE:31.30975},{LONGITUDE:121.38790,LATITUDE:31.30813},{LONGITUDE:121.38606,LATITUDE:31.30934},{LONGITUDE:121.38159,LATITUDE:31.31000},{LONGITUDE:121.37889,LATITUDE:31.30857},{LONGITUDE:121.36799,LATITUDE:31.30876},{LONGITUDE:121.36202,LATITUDE:31.30600},{LONGITUDE:121.35353,LATITUDE:31.30780},{LONGITUDE:121.35374,LATITUDE:31.30479},{LONGITUDE:121.35014,LATITUDE:31.30468},{LONGITUDE:121.34529,LATITUDE:31.29970},{LONGITUDE:121.34110,LATITUDE:31.30028},{LONGITUDE:121.34190,LATITUDE:31.29739},{LONGITUDE:121.33334,LATITUDE:31.29502},{LONGITUDE:121.34054,LATITUDE:31.28631},{LONGITUDE:121.33998,LATITUDE:31.28439},{LONGITUDE:121.33874,LATITUDE:31.28431},{LONGITUDE:121.33830,LATITUDE:31.28395},{LONGITUDE:121.34408,LATITUDE:31.28305},{LONGITUDE:121.36689,LATITUDE:31.27729},{LONGITUDE:121.36704,LATITUDE:31.27390},{LONGITUDE:121.36638,LATITUDE:31.27081},{LONGITUDE:121.38867,LATITUDE:31.26696},{LONGITUDE:121.39211,LATITUDE:31.27010},{LONGITUDE:121.39977,LATITUDE:31.27113},{LONGITUDE:121.44875,LATITUDE:31.26181},{LONGITUDE:121.45582,LATITUDE:31.25932},{LONGITUDE:121.45636,LATITUDE:31.26154},{LONGITUDE:121.46017,LATITUDE:31.26484},{LONGITUDE:121.45841,LATITUDE:31.26793},{LONGITUDE:121.45428,LATITUDE:31.27407},{LONGITUDE:121.44522,LATITUDE:31.28278},{LONGITUDE:121.44185,LATITUDE:31.29052},{LONGITUDE:121.43904,LATITUDE:31.28753},{LONGITUDE:121.43843,LATITUDE:31.29086},{LONGITUDE:121.42844,LATITUDE:31.29061},{LONGITUDE:121.42636,LATITUDE:31.29410},{LONGITUDE:121.39963,LATITUDE:31.29268}]}");
				// grid.insert();
				// 平顺分局
				// grid = new Grid(
				// "{'GRID_CODE':'3','GRID_NAME':'平顺分局','GRID_COORDINATES':[{LONGITUDE:121.40850,LATITUDE:31.34395},{LONGITUDE:121.40584,LATITUDE:31.34146},{LONGITUDE:121.41022,LATITUDE:31.32921},{LONGITUDE:121.40756,LATITUDE:31.32298},{LONGITUDE:121.40713,LATITUDE:31.31880},{LONGITUDE:121.40756,LATITUDE:31.31308},{LONGITUDE:121.40352,LATITUDE:31.30611},{LONGITUDE:121.39963,LATITUDE:31.29268},{LONGITUDE:121.42636,LATITUDE:31.29410},{LONGITUDE:121.42844,LATITUDE:31.29061},{LONGITUDE:121.43843,LATITUDE:31.29086},{LONGITUDE:121.43904,LATITUDE:31.28753},{LONGITUDE:121.44185,LATITUDE:31.29052},{LONGITUDE:121.44522,LATITUDE:31.28278},{LONGITUDE:121.45428,LATITUDE:31.27407},{LONGITUDE:121.45841,LATITUDE:31.26793},{LONGITUDE:121.46581,LATITUDE:31.27139},{LONGITUDE:121.46427,LATITUDE:31.27417},{LONGITUDE:121.47005,LATITUDE:31.27707},{LONGITUDE:121.47250,LATITUDE:31.27534},{LONGITUDE:121.47710,LATITUDE:31.27812},{LONGITUDE:121.47523,LATITUDE:31.28009},{LONGITUDE:121.47796,LATITUDE:31.28509},{LONGITUDE:121.46888,LATITUDE:31.28598},{LONGITUDE:121.46832,LATITUDE:31.28807},{LONGITUDE:121.46883,LATITUDE:31.29097},{LONGITUDE:121.46797,LATITUDE:31.29485},{LONGITUDE:121.46673,LATITUDE:31.29606},{LONGITUDE:121.46978,LATITUDE:31.30021},{LONGITUDE:121.47154,LATITUDE:31.30388},{LONGITUDE:121.47063,LATITUDE:31.31077},{LONGITUDE:121.47703,LATITUDE:31.31183},{LONGITUDE:121.48390,LATITUDE:31.31799},{LONGITUDE:121.48480,LATITUDE:31.32148},{LONGITUDE:121.48209,LATITUDE:31.32804},{LONGITUDE:121.47529,LATITUDE:31.32638},{LONGITUDE:121.47433,LATITUDE:31.33493},{LONGITUDE:121.46956,LATITUDE:31.33310},{LONGITUDE:121.46042,LATITUDE:31.33288},{LONGITUDE:121.45188,LATITUDE:31.32998},{LONGITUDE:121.44351,LATITUDE:31.34890},{LONGITUDE:121.43656,LATITUDE:31.34813},{LONGITUDE:121.43321,LATITUDE:31.34450},{LONGITUDE:121.42540,LATITUDE:31.34351},{LONGITUDE:121.41889,LATITUDE:31.34498}]}");
				// grid.insert();
				// 和田分局
				// grid = new Grid(
				// "{'GRID_CODE':'4','GRID_NAME':'和田分局','GRID_COORDINATES':[{LONGITUDE:121.47796,LATITUDE:31.28509},{LONGITUDE:121.47523,LATITUDE:31.28009},{LONGITUDE:121.47710,LATITUDE:31.27812},{LONGITUDE:121.47250,LATITUDE:31.27534},{LONGITUDE:121.47005,LATITUDE:31.27707},{LONGITUDE:121.46427,LATITUDE:31.27417},{LONGITUDE:121.46581,LATITUDE:31.27139},{LONGITUDE:121.45841,LATITUDE:31.26793},{LONGITUDE:121.46017,LATITUDE:31.26484},{LONGITUDE:121.45636,LATITUDE:31.26154},{LONGITUDE:121.45582,LATITUDE:31.25932},{LONGITUDE:121.47317,LATITUDE:31.25256},{LONGITUDE:121.47724,LATITUDE:31.25359},{LONGITUDE:121.48554,LATITUDE:31.25867},{LONGITUDE:121.48723,LATITUDE:31.26145},{LONGITUDE:121.48665,LATITUDE:31.26623},{LONGITUDE:121.47983,LATITUDE:31.27375},{LONGITUDE:121.48294,LATITUDE:31.27662},{LONGITUDE:121.48482,LATITUDE:31.28166}]}");
				// grid.insert();
				//
				// grid = new Grid("{GRID_CODE:'BQ-PS-SD-5045'}");
				// System.out.println(grid.exist());
				// grid.delete();
				// System.out.println(grid.exist());
				//
				// grid = new Grid("{GRID_CODE:'BQ-PS-SD-5043'}");
				// System.out.println(Grid.findOne(grid.toString()));
				// grid.update("{GRID_CODE:'BQ-PS-SD-5043',GRID_NAME:'上海市体育运动学校',GRID_MANAGER:'钱惠平',GRID_ADDRESS:'上海市虹口区广中路406号',GRID_COORDINATES:[{LATITUDE:31.25214,LONGITUDE:121.46386},{LATITUDE:31.25313,LONGITUDE:121.46892}]}");
				// System.out.println(Grid.findOne(grid.toString()));
				// --------------------Test MongoDB End--------------------
			}
		}
		return result;
	}

}
